# Windows 常用命令

```powershell
# 遇到 PowerShell 被禁用（管理员终端）
set-ExecutionPolicy RemoteSigned

# 开关虚拟化（管理员终端）
# 开启后可以使用 Hyper-V、WSL2，关闭虚拟化可以优化性能，一般不建议关闭
bcdedit /set hypervisorlaunchtype auto
bcdedit /set hypervisorlaunchtype off

# 刷新 DNS 缓存，可能会用到
ipconfig /flushdns

# 编辑 hosts，注意编码必须是 ANSI，不能使用 UTF-8 等格式
#（推荐使用 PowerToys 来管理 hosts）
notepad c:\windows\system32\drivers\etc\hosts

# 解除 Windows 系统对 FTP 传输速度的限制
netsh int tcp set global autotuninglevel=restricted
netsh interface tcp set heuristics disabled

# 修改终端编码为 UTF-8（默认是 GBK）
chcp 65001
# 修改回 GBK
chcp 936
```

## 端口占用问题

```bash
# 项目启动提示 3000 端口被占用
# 可以找到占用的进程的 PID：
netstat -ano | findstr "3000"

# 如果还找不到任何进程，依次执行（管理员终端）：
# WSL 用户请勿执行，会导致 WSL 无法联网，见下文
net stop winnat
net start winnat

# Windows 网络问题修复
# 也可以解决上面找不到占用端口进程的问题
# WSL 用户请勿执行，会导致 WSL 无法联网，见下文
netsh winsock reset
```

注意，上文中一部分指令标注了 “WSL 用户请勿执行” 的指令，如果执行了，请重启电脑，单纯重启 WSL 是仍然无法联网的。

---

WSL 用户遇到端口被占却查不到进程，或者是 Docker 用户遇到 `permission denied 0.0.0.0:<端口号>` 这类问题时，参考以下方法：

Windows 系统存在一种 “TCP 动态端口范围” 的名词，这个范围内的端口号有时会被一些服务占用。<br />
Windows Vista 和以前的系统，这个范围是 `1025` - `5000`；之后的操作系统，这个范围是 `49152` - `65535`；<br />
我们现在用的都是 Windows 10、11，所以基本不再会受到这些影响了。

而且，如果启用了 Hyper-V，它也会保留一些随机端口号供 Windows 容器主机网络服务使用，它预留的端口号一般都很大，不太会产生影响。

**但是 Windows 自动更新有时会出错（万恶的自动更新），把 “TCP 动态端口范围” 起始端口被重置为 `1024`，导致 Hyper-V 在预留端口的时候占用了常用端口号，使得一些常用端口因为被预留而无法使用。**

查看当前的 “TCP 动态端口范围”：

```powershell
# 如果是 1024 开头，就是出现了上文中的问题
netsh int ipv4 show dynamicport tcp
```

解决方法：

```bash
netsh int ipv4 set dynamic tcp start=49152 num=16384
netsh int ipv6 set dynamic tcp start=49152 num=16384
```

执行后，请重新启动电脑。

此外，操作系统会保留一部分端口，这个指令可以查看哪些端口号被保留：

```bash
# 查看系统排除了哪些端口号
netsh interface ipv4 show excludedportrange protocol=tcp
```

更多配置，可以参考 [PowerShell 备忘清单](https://code.paperplane.cc/docs/powershell.html)（自部署）。
